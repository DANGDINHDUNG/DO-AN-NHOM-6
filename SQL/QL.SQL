CREATE DATABASE QLKS

CREATE TABLE KHACHHANG
(
	MAKH  varchar(5) PRIMARY KEY, --Khóa chính
	HOTEN Nvarchar(40),
	TUOI INT,
	CCCD_CMND varchar(12),
	SDT VARCHAR(12),
	GIOITINH NVARCHAR(3)
)

create table NHANVIEN
(
	MANV char(4) primary key,
	TENTK varchar(40),
	MATKHAU varchar(96),
	HOTEN Nvarchar(40),
	TUOI int,
	NGVL smalldatetime,
	SDT varchar(12),
	CCCD_CMND varchar(12),
	SODONDP int,
	LUONG money,
	GIOITINH NVARCHAR(3)
)

CREATE TABLE PHONG
(
	MAPHONG INT IDENTITY(1,1) PRIMARY KEY,
	TENPHONG NVARCHAR(20),
	TRANGTHAI NVARCHAR(20),
	MALP VARCHAR(3)
)

CREATE TABLE LOAIPHONG
(
	MALP VARCHAR(3) PRIMARY KEY,
	TENLP NVARCHAR(20),
	GIA MONEY
)

CREATE TABLE DICHVU
(
	MADV varchar(3) PRIMARY KEY,
	TENDV NVARCHAR(40),
	GIA MONEY,
)

CREATE TABLE HOADON
(
	MADV varchar(3),
	MAHD INT IDENTITY(1,1) PRIMARY KEY,
	NGAYLAP SMALLDATETIME,
	HINHTHUCTT VARCHAR(20),
	TINHTIEN MONEY,
	MAKH varchar(5),
	MANV varchar(4)
)

CREATE TABLE DATPHONG
(
	MAKH varchar(5),
	MAPHONG INT,
	CONSTRAINT FK_DATPHONG PRIMARY KEY( MAPHONG,MAKH),
	NGAYDAT SMALLDATETIME,
	NGAYDI SMALLDATETIME,
	THANHTOAN NVARCHAR(20)
)

CREATE TABLE DOIPHONG
(
	MAKH varchar(5),
	NGAYDOI SMALLDATETIME,
	MAPCU INT,
	MAPMOI INT,
	CONSTRAINT FK_DOIPHONG PRIMARY KEY(MAKH,MAPMOI,MAPCU) 
)

CREATE TABLE DOANHTHU
(
	DOANHTHU MONEY,
	NAM INT IDENTITY(2010,1),
)

ALTER TABLE PHONG ADD CONSTRAINT FK_MALP FOREIGN KEY (MALP) REFERENCES LOAIPHONG(MALP)
ALTER TABLE DATPHONG ADD CONSTRAINT DP_MAKH FOREIGN KEY (MAKH) REFERENCES KHACHHANG (MAKH)
ALTER TABLE DATPHONG ADD CONSTRAINT DP_MAPHONG FOREIGN KEY (MAPHONG) REFERENCES PHONG(MAPHONG) 
ALTER TABLE DOIPHONG ADD CONSTRAINT DOI_MAKH FOREIGN KEY (MAKH) REFERENCES KHACHHANG (MAKH) 
ALTER TABLE DOIPHONG ADD CONSTRAINT FK_MAPCU FOREIGN KEY (MAPCU) REFERENCES PHONG(MAPHONG) 
ALTER TABLE DOIPHONG ADD CONSTRAINT FK_MAPMOI FOREIGN KEY (MAPMOI) REFERENCES PHONG(MAPHONG) 
ALTER TABLE HOADON ADD CONSTRAINT HD_MAKH FOREIGN KEY (MAKH) REFERENCES KHACHHANG (MAKH) 
alter table HOADON add constraint HD_MADV foreign key (MADV) references DICHVU(MADV)

ALTER TABLE PHONG ADD CONSTRAINT CHK_TRANGTHAI CHECK (TRANGTHAI IN(N'TRỐNG',N'ĐÃ THUÊ'))
ALTER TABLE DATPHONG ADD CONSTRAINT CHK_NGAYDI CHECK (NGAYDI > NGAYDAT)

INSERT INTO NHANVIEN(MANV, TENTK,MATKHAU) VALUES ('ADM', 'ADMIN','8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92')
INSERT INTO NHANVIEN(MANV, TENTK,MATKHAU) VALUES ('11', '1','6b86b273ff34fce19d6b804eff5a3f5747ada4eaa22f1d49c01e52ddb7875b4b')

SET DATEFORMAT DMY 

-------------------------------------------------NHAP LOAI PHONG-------------------------------------------

INSERT INTO LOAIPHONG(MALP, TENLP, GIA) VALUES ('RST', N'Phòng tổng thống', '50,000,000')
INSERT INTO LOAIPHONG(MALP, TENLP, GIA) VALUES ('VIP', N'Phòng VIP', '10,000,000')
INSERT INTO LOAIPHONG(MALP, TENLP, GIA) VALUES ('NRM', N'Phòng phổ thông', '5,000,000')

-------------------------------------------------NHAP SO PHONG-------------------------------------------

INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'TỔNG THỐNG 1', N'Trống', 'RST') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'TỔNG THỐNG 2', N'Trống', 'RST') 

INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'V.I.P 1', N'Trống', 'VIP') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'V.I.P 2', N'Trống', 'VIP') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'V.I.P 3', N'Trống', 'VIP') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'V.I.P 4', N'Trống', 'VIP') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'V.I.P 5', N'Trống', 'VIP') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'V.I.P 6', N'Trống', 'VIP') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'V.I.P 7', N'Trống', 'VIP') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'V.I.P 8', N'Trống', 'VIP') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'V.I.P 9', N'Trống', 'VIP') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'V.I.P 10', N'Trống', 'VIP') 

INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'PHỔ THÔNG 1', N'Trống', 'NRM') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'PHỔ THÔNG 2', N'Trống', 'NRM') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'PHỔ THÔNG 3', N'Trống', 'NRM') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'PHỔ THÔNG 4', N'Trống', 'NRM') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'PHỔ THÔNG 5', N'Trống', 'NRM') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'PHỔ THÔNG 6', N'Trống', 'NRM') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'PHỔ THÔNG 7', N'Trống', 'NRM') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'PHỔ THÔNG 8', N'Trống', 'NRM') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'PHỔ THÔNG 9', N'Trống', 'NRM') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'PHỔ THÔNG 10', N'Trống', 'NRM') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'PHỔ THÔNG 11', N'Trống', 'NRM') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'PHỔ THÔNG 12', N'Trống', 'NRM') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'PHỔ THÔNG 13', N'Trống', 'NRM') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'PHỔ THÔNG 14', N'Trống', 'NRM') 
INSERT INTO PHONG(TENPHONG,TRANGTHAI,MALP) VALUES (N'PHỔ THÔNG 15', N'Trống', 'NRM') 

insert into HOADON(NGAYLAP, HINHTHUCTT, TINHTIEN) values ('20/11/2021', 'VISA', '10,000,000')
insert into HOADON(NGAYLAP, HINHTHUCTT, TINHTIEN) values ('20/11/2022', 'VISA', '50,000,000')
insert into HOADON(NGAYLAP, HINHTHUCTT, TINHTIEN) values ('20/11/2023', 'VISA', '5,000,000')

-------------------------------------------------NHAP DICH VU-------------------------------------------

INSERT INTO DICHVU(MADV, TENDV, GIA) VALUES ('RFD', N'Giao đồ ăn tạn phòng(đ/lần)', '30,000')
INSERT INTO DICHVU(MADV, TENDV, GIA) VALUES ('PAR', N'Thuê sảnh tổ chức tiệc(đ/giờ)', '1,000,000')
INSERT INTO DICHVU(MADV, TENDV, GIA) VALUES ('MSG', N'Massage(đ/giờ)', '1,500,000')
INSERT INTO DICHVU(MADV, TENDV, GIA) VALUES ('LAU', N'Giặt ủi(đ/bộ)', '1,000,000')
INSERT INTO DICHVU(MADV, TENDV, GIA) VALUES ('CAR', N'Thuê xe đưa đón theo lịch', '5,000,000')
INSERT INTO DICHVU(MADV, TENDV, GIA) VALUES ('SPT', N'Sân golf và tennis(đ/giờ)', '5,000,000')
INSERT INTO DICHVU(MADV, TENDV, GIA) VALUES ('FIT', N'Fitness centre(đ/3h)', '1,000,000')
INSERT INTO DICHVU(MADV, TENDV, GIA) VALUES ('SWM', N'Bể bơi', '0')
INSERT INTO DICHVU(MADV, TENDV, GIA) VALUES ('CLN', N'Dọn phòng', '4,000,000')
INSERT INTO DICHVU(MADV, TENDV, GIA) VALUES ('BST', N'Chăm trẻ(đ/giờ)', '1,000,000')

---ĐĂNG NHẬP
SELECT MANV
FROM NHANVIEN
WHERE TENTK='' AND MATKHAU=''
--Gía trị lấy tự winform

--ĐỔI MẬT KHẨU
UPDATE NHANVIEN
SET MATKHAU=''--GIÁ TRỊ MẬT KHẨU LẤY TỪ WINFORM
WHERE TENTK=''--GIÁ TRỊ  TENTK LẤY TỪ WINFORM
	
--ĐĂNG KÍ
SELECT MAX(MANV) FROM NHANVIEN
-->LẤY MANV LỚN NHẤT ĐỀ TẠO MANV KẾ TIẾP
INSERT INTO NHANVIEN VALUES ('','','','','','','')
-->ĐIỀN CÁC GIÁ TRỊ LẤY TỪ WINFORM

--TÌM PHÒNG 
SELECT MAPHONG,TENPHONG,TENLP,TRANGTHAI
FROM PHONG INNER JOIN LOAIPHONG
ON PHONG.MALP=LOAIPHONG.MALP AND MAPHONG=''
-->TÊN MAPHONG LẤY TỪ WINFORM

--DOANH THU
UPDATE DOANHTHU
SET DOANHTHU = (SELECT SUM(TINHTIEN) FROM HOADON WHERE DOANHTHU.NAM = YEAR(HOADON.NGAYLAP))
--> NĂM DOANH THU LAY TỪ FORM


select PHONG.MALP 'Mã phòng', PHONG.TENPHONG 'Tên phòng', TRANGTHAI 'Trạng thái', GIA 'Giá tiền' 
from PHONG inner join LOAIPHONG on PHONG.MALP = LOAIPHONG.MALP 
where PHONG.MALP = substring('RST (Phòng tổng thống)', 1, 3)

update PHONG set TRANGTHAI = N'ĐÃ THUÊ' where PHONG.TENPHONG = N'TỔNG THỐNG 2' 

update KHACHHANG set MAKH = 'KH' + cast((select count(MAKH) + 1 from KHACHHANG) as varchar(2))

insert into DATPHONG(NGAYDAT,NGAYDI,THANHTOAN) values (20/11/2021, 21/11/2021, N'Tiền mặt')
